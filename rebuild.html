<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒªãƒ“ãƒ«ãƒ‰ãƒ­ã‚°</title>
    <link rel="stylesheet" href="./rebuild_style.css">
    <link rel="icon" href="https://mikatea.sakura.ne.jp/Adeline/auth/favicon.ico" type="image/x-icon">
</head>

<body>
<div class="log-section">
    <h1>ğŸ“ˆ ãƒªãƒ“ãƒ«ãƒ‰ãƒ­ã‚°</h1>
    <p>ã‚ãªãŸã®ãƒ­ã‚°ã‚¤ãƒ³å±¥æ­´ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
    <ul id="logList"></ul>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
import { getFirestore, collection, query, where, orderBy, getDocs } 
    from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

// â˜…githubã‚¢ãƒƒãƒ—æ™‚ã«å¿˜ã‚Œãšæ¶ˆã™ã“ã¨ï¼â˜…
const firebaseConfig = {
    apiKey: "",
    authDomain: "",
    projectId: "",
    storageBucket: "",
    messagingSenderId: "",
    appId: "",
    measurementId: ""
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

    onAuthStateChanged(auth, async (user) => {
        if (!user) {
            location.href = "../auth/auth.html";
            return;
        }

        try {
            const q = query(
                collection(db, "users", user.uid, "logs"),
                orderBy("timestamp", "desc")
            );
            const snap = await getDocs(q);
            const list = document.getElementById("logList");

            list.innerHTML = "";

            if (snap.empty) {
                list.innerHTML = "<li>å±¥æ­´ãŒã¾ã ã‚ã‚Šã¾ã›ã‚“ã€‚</li>";
                return;
            }

            snap.forEach(doc => {
                const data = doc.data();
                const li = document.createElement("li");
                const formatted = data.timestamp?.toDate().toLocaleString("ja-JP", {
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                });
                li.textContent = `${data.action} @ ${formatted}`;
                list.appendChild(li);
            });
        } catch (e) {
            console.error("ãƒ­ã‚°å–å¾—ã‚¨ãƒ©ãƒ¼:", e);
            alert("ãƒ­ã‚°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
        }
    });

    // â³ ã‚¢ã‚¤ãƒ‰ãƒ«æ¤œå‡ºï¼ˆæ“ä½œãŒãªã‘ã‚Œã°è‡ªå‹•ãƒ­ã‚°ã‚¢ã‚¦ãƒˆï¼‰
    let idleTimer;
    const IDLE_TIMEOUT = 1000 * 60 * 10; // 10åˆ†ï¼ˆãƒŸãƒªç§’ï¼‰

    const resetIdleTimer = () => {
        clearTimeout(idleTimer);
        idleTimer = setTimeout(async () => {
            await signOut(auth);
            alert("10åˆ†é–“æ“ä½œãŒãªã‹ã£ãŸãŸã‚è‡ªå‹•ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã•ã‚Œã¾ã—ãŸã€‚");
            location.href = "https://mikatea.sakura.ne.jp/Adeline/index/index.html";
        }, IDLE_TIMEOUT);
    };

    ["mousemove", "keydown", "click", "scroll"].forEach(evt => {
        document.addEventListener(evt, resetIdleTimer, false);
    });
</script>
</body>
</html>