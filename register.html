<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°è¦ç™»éŒ²</title>
    <link rel="stylesheet" href="auth_style.css">
    <link rel="icon" href="https://mikatea.sakura.ne.jp/Adeline/auth/favicon.ico" type="image/x-icon">
</head>

<body>
<main>
    <div class="form-container">
    <h2>ğŸ“ æ–°è¦ç™»éŒ²</h2>
    <form id="registerForm">
        <label for="username">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
        <input type="text" id="username" placeholder="è¡¨ç¤ºå" required>

        <label for="userId">ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆ@ã‹ã‚‰å§‹ã‚ãªã„ã§ï¼‰</label>
        <input type="text" id="userId" placeholder="ä¸€æ„ã®ID" required>

        <label for="email">ãƒ¡ãƒ¼ãƒ«</label>
        <input type="email" id="email" placeholder="you@example.com" required>

        <label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
        <input type="password" id="password" placeholder="******" required minlength="6">

        <button type="submit" class="btn">ç™»éŒ²ã™ã‚‹ (Email/Password)</button>
    </form>

        <div class="help">
            æ—¢ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒã‚ã‚‹ï¼Ÿ <a href="./auth.html">ãƒ­ã‚°ã‚¤ãƒ³ã¸</a><br>
            ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å¿˜ã‚ŒãŸï¼Ÿ <a href="./reset.html">å†è¨­å®š</a><br>
            ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹ â†’ <a href="../index/index.html">ãƒˆãƒƒãƒ—</a>
        </div>

        <div id="msg"></div>
    </div>
</main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, doc, runTransaction, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// â˜…githubã‚¢ãƒƒãƒ—æ™‚ã«å¿˜ã‚Œãšæ¶ˆã™ã“ã¨ï¼â˜…
const firebaseConfig = {
    apiKey: "",
    authDomain: "",
    projectId: "",
    storageBucket: "",
    messagingSenderId: "",
    appId: "",
    measurementId: ""
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const msg = document.getElementById("msg");
    const showMsg = (t, ok=false) => {
        msg.textContent = t;
        msg.className = ok ? "success" : "error";
    };

    document.getElementById("registerForm").addEventListener("submit", async (e) => {
        e.preventDefault();

        const username = document.getElementById("username").value.trim();
        const userId   = document.getElementById("userId").value.trim();
        const email    = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value;

        if (!username || !userId || !email || !password) {
            return showMsg("ã™ã¹ã¦ã®é …ç›®ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        }

        try {
            const cred = await createUserWithEmailAndPassword(auth, email, password);
            const uid = cred.user.uid;

            await updateProfile(cred.user, { displayName: username });

            await runTransaction(db, async (transaction) => {
                const unameRef = doc(db, "usernames", userId);
                const unameSnap = await transaction.get(unameRef);
                if (unameSnap.exists()) {
                    throw new Error("ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã¯æ—¢ã«ä½¿ã‚ã‚Œã¦ã„ã¾ã™ã€‚");
                }

            transaction.set(unameRef, { uid });
            transaction.set(doc(db, "users", uid), {
                userId,
                username,
                email,
                createdAt: serverTimestamp()
            });
            });

            showMsg("ç™»éŒ²å®Œäº†ï¼", true);
            window.location.href = "../start/start.html";
        } catch (e) {
            console.error(e);
            showMsg("ç™»éŒ²å¤±æ•—: " + e.message);
        }
    });
</script>
</body>
</html>