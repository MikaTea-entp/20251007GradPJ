<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>SCAMPER</title>
<link href="https://fonts.googleapis.com/css2?family=M+PLUS+1p:wght@400;700&display=swap" rel="stylesheet">
<link rel="icon" href="https://mikatea.sakura.ne.jp/Adeline/auth/favicon.ico" type="image/x-icon">
<style>
    body { font-family: 'M PLUS 1p', sans-serif; background: #1a202c; color: #fefefe; padding: 2rem; text-align: center; }
    .card { background: rgba(0,0,0,0.5); padding: 2rem; border-radius: 12px; max-width: 900px; margin: 1rem auto; }
    button { margin: 0.2rem; padding: 0.6rem 1.2rem; font-size: 0.9rem; font-weight: 600; border: none; border-radius: 6px;
             cursor: pointer; }
    .btn-save { background: linear-gradient(135deg,#63b3ed,#3182ce); color: #fff; }
    .btn-edit { background: #f6ad55; color: #1a202c; }
    .btn-delete { background: #e53e3e; color: #fff; }
    .btn-ai { background: #48bb78; color: #fff; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    textarea { width: 100%; padding: 1rem; border-radius: 8px; border: none; margin-top: 1rem;
               font-size: 1rem; font-family: inherit; resize: vertical; min-height: 80px; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { padding: 0.6rem; border-bottom: 1px solid rgba(255,255,255,0.2); }
    th { text-align: left; color: #90cdf4; }
    td.actions { text-align: right; }
    pre { text-align:left; white-space: pre-wrap; background:rgba(255,255,255,0.1); padding:1rem; border-radius:8px; }
    
    .idea-row { cursor: pointer; transition: background 0.2s; }
    .idea-row:hover { background: rgba(99,179,237,0.1); }
    .ai-suggestions { 
        background: rgba(72,187,120,0.15); 
        padding: 1rem; 
        margin: 0.5rem 0;
        border-left: 3px solid #48bb78;
        border-radius: 4px;
        display: none;
    }
    .ai-suggestions.show { display: block; }
    .ai-suggestions h4 { margin: 0 0 0.5rem 0; color: #68d391; font-size: 0.9rem; }
    .ai-loading { color: #90cdf4; font-style: italic; }
    .toggle-icon { 
        display: inline-block; 
        transition: transform 0.2s;
        margin-right: 0.5rem;
        font-size: 0.8rem;
    }
    .toggle-icon.open { transform: rotate(90deg); }
</style>
</head>

<body>
<h1>ğŸ’¡ SCAMPER ã‚¢ã‚¤ãƒ‡ã‚¢ç™ºæƒ³</h1>

<div id="problemCard" class="card">
    <h2>èª²é¡Œå®šç¾©</h2>
    <p id="definitionText">èª²é¡Œã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
</div>

<div id="gachaCard" class="card">
    <h2 id="scamperTitle">ğŸ² ã‚¬ãƒãƒ£ã‚’å›ãã†ï¼</h2>
    <p id="scamperPrompt">SCAMPERãƒ¡ã‚½ãƒƒãƒ‰ã®åˆ‡ã‚Šå£ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
    <button class="btn-save" id="gachaBtn">ã‚¬ãƒãƒ£ã‚’å›ã™</button>
</div>

<div id="aiAskCard" class="card">
    <h2>ğŸ§© AIã«ç›´æ¥ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’èã</h2>
    <textarea id="aiAskInput" placeholder="ä¾‹: â—‹â—‹ã‚’æ”¹å–„ã™ã‚‹ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’3ã¤æ•™ãˆã¦" rows="3"></textarea>
    <button class="btn-ai" id="aiAskBtn">AIã«èã</button>
    <div id="aiAskResult" style="margin-top:1rem; display:none;">
        <h3 style="color:#68d391; font-size:1rem;">ğŸ’¡ AIææ¡ˆ</h3>
        <div id="aiAskContent" style="background:rgba(72,187,120,0.15); padding:1rem; border-radius:8px; border-left:3px solid #48bb78;"></div>
    </div>
</div>

<div id="ideaCard" class="card" style="display:none;">
    <h2>âœï¸ ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’æ›¸ã“ã†</h2>
    <p id="currentMethod"></p>
    <textarea id="ideaInput" placeholder="ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å…¥åŠ›..."></textarea>
    <button class="btn-save" id="saveIdeaBtn">ä¿å­˜ã™ã‚‹</button>
</div>

<div id="listCard" class="card" style="display:none;">
    <h2>ğŸ’­ ä¿å­˜ã—ãŸã‚¢ã‚¤ãƒ‡ã‚¢</h2>
    <p style="font-size: 0.9rem; color: #90cdf4;">ğŸ’¡ ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨AIè£œå®ŒçµæœãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
    <table>
        <thead>
            <tr><th>æ–¹æ³•</th><th>ã‚¢ã‚¤ãƒ‡ã‚¢</th><th>æ“ä½œ</th></tr>
        </thead>
        <tbody id="ideaList"></tbody>
    </table>
    <button class="btn-ai" id="summarizeBtn">ğŸ—‚ AIã§æ•´ç†ã™ã‚‹</button>
    <div id="summaryBox" style="margin-top:1rem; display:none;">
        <h3>æ•´ç†çµæœ</h3>
        <pre id="summaryText"></pre>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getFirestore, doc, getDoc, collection, addDoc, query, orderBy, onSnapshot, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";

// === Firebaseè¨­å®š ===
// â˜…githubã‚¢ãƒƒãƒ—æ™‚ã«å¿˜ã‚Œãšæ¶ˆã™ã“ã¨ï¼â˜…
const firebaseConfig = {
    apiKey: "",
    authDomain: "",
    projectId: "",
    storageBucket: "",
    messagingSenderId: "",
    appId: "",
    measurementId: ""
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUser = null;
let currentMethod = null;
let editId = null;

// === SCAMPERãƒ¡ã‚½ãƒƒãƒ‰ä¸€è¦§ ===
const scamperList = [
    {title:"S: Substitute (ä»£æ›¿ã™ã‚‹)", prompt:"åˆ¥ã®ææ–™ã‚„æ–¹æ³•ã«ç½®ãæ›ãˆã‚‰ã‚Œã‚‹ï¼Ÿ"},
    {title:"C: Combine (çµ„ã¿åˆã‚ã›ã‚‹)", prompt:"ä»–ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚„æ©Ÿèƒ½ã¨çµ„ã¿åˆã‚ã›ã‚‰ã‚Œã‚‹ï¼Ÿ"},
    {title:"A: Adapt (å¿œç”¨ã™ã‚‹)", prompt:"ä»–åˆ†é‡ã®ã‚„ã‚Šæ–¹ã‚’å¿œç”¨ã§ããªã„ã‹ï¼Ÿ"},
    {title:"M: Modify/Magnify (ä¿®æ­£ãƒ»æ‹¡å¤§)", prompt:"ä¸€éƒ¨ã‚’å¼·èª¿ãƒ»æ‹¡å¤§ã—ãŸã‚‰ã©ã†ãªã‚‹ï¼Ÿ"},
    {title:"P: Put to other use (ä»–ç”¨é€”ã«è»¢ç”¨)", prompt:"åˆ¥ã®å ´é¢ã‚„ç”¨é€”ã§ä½¿ãˆãªã„ã‹ï¼Ÿ"},
    {title:"E: Eliminate (å‰Šé™¤ã™ã‚‹)", prompt:"å–ã‚Šé™¤ã„ã¦ã‚‚æˆç«‹ã™ã‚‹éƒ¨åˆ†ã¯ï¼Ÿ"},
    {title:"R: Reverse/Rearrange (é€†è»¢ãƒ»ä¸¦ã¹æ›¿ãˆ)", prompt:"é †åºã‚„è¦–ç‚¹ã‚’é€†ã«ã—ãŸã‚‰ï¼Ÿ"}
];

// === OpenAIå‘¼ã³å‡ºã—ï¼ˆPHPçµŒç”±ï¼‰ ===
async function callAI(prompt) {
    try {
        const response = await fetch('./scamper_api.php', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ prompt })
        });

        if (!response.ok) {
            throw new Error(`HTTPã‚¨ãƒ©ãƒ¼: ${response.status}`);
        }

        const data = await response.json();
        
        if (!data.success) {
            throw new Error(data.error || 'APIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }

        return data.content;
    } catch (error) {
        console.error('AIå‘¼ã³å‡ºã—ã‚¨ãƒ©ãƒ¼:', error);
        return `ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`;
    }
}

// === ãƒ­ã‚°ã‚¤ãƒ³ç›£è¦– ===
onAuthStateChanged(auth, async (user) => {
    if (!user) { 
        await signInAnonymously(auth); 
        return; 
    }
    currentUser = user;
    loadProblem();
    loadIdeas();
});

// === èª²é¡Œå®šç¾©èª­è¾¼ ===
async function loadProblem() {
    try {
        const docRef = doc(db, "users", currentUser.uid, "definitions", "current");
        const docSnap = await getDoc(docRef);
        document.getElementById("definitionText").textContent =
            docSnap.exists() ? (docSnap.data().definition || "èª²é¡ŒãŒæœªå…¥åŠ›ã§ã™") : "èª²é¡ŒãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“";
    } catch (error) {
        console.error('èª²é¡Œèª­è¾¼ã‚¨ãƒ©ãƒ¼:', error);
        document.getElementById("definitionText").textContent = "èª­è¾¼ã«å¤±æ•—ã—ã¾ã—ãŸ";
    }
}

// === ã‚¬ãƒãƒ£ ===
document.getElementById("gachaBtn").addEventListener("click", () => {
    const choice = scamperList[Math.floor(Math.random()*scamperList.length)];
    currentMethod = choice.title;
    document.getElementById("scamperTitle").textContent = choice.title;
    document.getElementById("scamperPrompt").textContent = choice.prompt;
    document.getElementById("ideaCard").style.display = "block";
    document.getElementById("currentMethod").textContent = "æ–¹æ³•: " + choice.title;
});

// === ã‚¢ã‚¤ãƒ‡ã‚¢ä¿å­˜ï¼ˆAIè£œå®Œä»˜ãï¼‰ ===
document.getElementById("saveIdeaBtn").addEventListener("click", async () => {
    const idea = document.getElementById("ideaInput").value.trim();
    if (!idea) {
        alert('ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }

    const saveBtn = document.getElementById("saveIdeaBtn");
    saveBtn.disabled = true;
    saveBtn.textContent = 'ä¿å­˜ä¸­...';

    try {
        let ref;
        if (editId) {
            ref = doc(db, "users", currentUser.uid, "scamperIdeas", editId);
            await updateDoc(ref, { idea });
            editId = null;
        } else {
            ref = await addDoc(collection(db, "users", currentUser.uid, "scamperIdeas"), {
                method: currentMethod,
                idea,
                createdAt: new Date()
            });

            // AIè£œå®Œã‚’éåŒæœŸã§å®Ÿè¡Œ
            try {
                saveBtn.textContent = 'AIè£œå®Œä¸­...';
                const aiText = await callAI(
                    `SCAMPERãƒ¡ã‚½ãƒƒãƒ‰ã€Œ${currentMethod}ã€ã®ç™ºæƒ³ã§æ¬¡ã®ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’3ã¤è£œå®Œã—ã¦ãã ã•ã„:\n${idea}`
                );
                
                await addDoc(
                    collection(db, "users", currentUser.uid, "scamperIdeas", ref.id, "aiSuggestions"),
                    {
                        suggestion: aiText,
                        createdAt: new Date()
                    }
                );
            } catch (aiError) {
                console.error('AIè£œå®Œã‚¨ãƒ©ãƒ¼:', aiError);
            }
        }

        document.getElementById("ideaInput").value = "";
        alert('ä¿å­˜ã—ã¾ã—ãŸï¼');
        
    } catch (error) {
        console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
    } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'ä¿å­˜ã™ã‚‹';
    }
});

// === ã‚¢ã‚¤ãƒ‡ã‚¢ä¸€è¦§ ===
function loadIdeas() {
    const q = query(collection(db, "users", currentUser.uid, "scamperIdeas"), orderBy("createdAt", "desc"));
    onSnapshot(q, (snapshot) => {
        const list = document.getElementById("ideaList");
        list.innerHTML = "";
        
        snapshot.forEach(docSnap => {
            const data = docSnap.data();
            const ideaId = docSnap.id;
            
            // ã‚¢ã‚¤ãƒ‡ã‚¢è¡Œ
            const tr = document.createElement("tr");
            tr.className = "idea-row";
            tr.dataset.ideaId = ideaId;
            tr.innerHTML = `
                <td><span class="toggle-icon">â–¶</span>${data.method}</td>
                <td>${data.idea}</td>
                <td class="actions">
                    <button class="btn-edit" data-id="${ideaId}">ç·¨é›†</button>
                    <button class="btn-delete" data-id="${ideaId}">å‰Šé™¤</button>
                </td>`;
            list.appendChild(tr);
            
            // AIè£œå®Œè¡¨ç¤ºè¡Œ
            const suggestionTr = document.createElement("tr");
            suggestionTr.innerHTML = `
                <td colspan="3">
                    <div class="ai-suggestions" id="ai-${ideaId}">
                        <h4>ğŸ¤– AIè£œå®Œã‚¢ã‚¤ãƒ‡ã‚¢</h4>
                        <div class="ai-loading">èª­ã¿è¾¼ã¿ä¸­...</div>
                    </div>
                </td>`;
            list.appendChild(suggestionTr);
            
            // ã‚¯ãƒªãƒƒã‚¯ã§å±•é–‹/æŠ˜ã‚ŠãŸãŸã¿
            tr.addEventListener("click", async (e) => {
                if (e.target.closest('button')) return; // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã¯ç„¡è¦–
                
                const aiDiv = document.getElementById(`ai-${ideaId}`);
                const icon = tr.querySelector('.toggle-icon');
                
                if (aiDiv.classList.contains('show')) {
                    aiDiv.classList.remove('show');
                    icon.classList.remove('open');
                } else {
                    // ä»–ã‚’é–‰ã˜ã‚‹
                    document.querySelectorAll('.ai-suggestions').forEach(d => d.classList.remove('show'));
                    document.querySelectorAll('.toggle-icon').forEach(i => i.classList.remove('open'));
                    
                    aiDiv.classList.add('show');
                    icon.classList.add('open');
                    
                    // AIè£œå®Œã‚’èª­ã¿è¾¼ã‚€
                    await loadAISuggestions(ideaId);
                }
            });
        });

        // ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³
        document.querySelectorAll(".btn-edit").forEach(btn => {
            btn.addEventListener("click", async (e) => {
                e.stopPropagation();
                const id = e.target.dataset.id;
                const ref = doc(db, "users", currentUser.uid, "scamperIdeas", id);
                const snap = await getDoc(ref);
                if (snap.exists()) {
                    document.getElementById("ideaInput").value = snap.data().idea;
                    currentMethod = snap.data().method;
                    editId = id;
                    document.getElementById("ideaCard").style.display = "block";
                    document.getElementById("currentMethod").textContent = "æ–¹æ³•: " + snap.data().method + " (ç·¨é›†ä¸­)";
                }
            });
        });
        
        document.querySelectorAll(".btn-delete").forEach(btn => {
            btn.addEventListener("click", async (e) => {
                e.stopPropagation();
                if (confirm('å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                    const id = e.target.dataset.id;
                    await deleteDoc(doc(db, "users", currentUser.uid, "scamperIdeas", id));
                }
            });
        });

        if (!snapshot.empty) document.getElementById("listCard").style.display = "block";
    });
}

// === AIè£œå®Œã‚’èª­ã¿è¾¼ã‚“ã§è¡¨ç¤º ===
async function loadAISuggestions(ideaId) {
    const aiDiv = document.getElementById(`ai-${ideaId}`);
    
    try {
        const suggestionsRef = collection(db, "users", currentUser.uid, "scamperIdeas", ideaId, "aiSuggestions");
        const q = query(suggestionsRef, orderBy("createdAt", "desc"));
        const snapshot = await getDocs(q);
        
        if (snapshot.empty) {
            aiDiv.innerHTML = `
                <h4>ğŸ¤– AIè£œå®Œã‚¢ã‚¤ãƒ‡ã‚¢</h4>
                <p style="color: #a0aec0;">ã¾ã AIè£œå®ŒãŒç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“</p>`;
        } else {
            const suggestions = [];
            snapshot.forEach(doc => {
                suggestions.push(doc.data().suggestion);
            });
            
            aiDiv.innerHTML = `
                <h4>ğŸ¤– AIè£œå®Œã‚¢ã‚¤ãƒ‡ã‚¢</h4>
                <pre style="background: rgba(0,0,0,0.3); padding: 0.8rem; border-radius: 6px; margin: 0;">${suggestions.join('\n\n---\n\n')}</pre>`;
        }
    } catch (error) {
        console.error('AIè£œå®Œèª­è¾¼ã‚¨ãƒ©ãƒ¼:', error);
        aiDiv.innerHTML = `
            <h4>ğŸ¤– AIè£œå®Œã‚¢ã‚¤ãƒ‡ã‚¢</h4>
            <p style="color: #fc8181;">èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</p>`;
    }
}

// === AIè¦ç´„ãƒ»æ•´ç† ===
document.getElementById("summarizeBtn").addEventListener("click", async () => {
    const btn = document.getElementById("summarizeBtn");
    btn.disabled = true;
    btn.textContent = 'æ•´ç†ä¸­...';

    try {
        const snapshot = await getDocs(
            collection(db, "users", currentUser.uid, "scamperIdeas")
        );
        
        if (snapshot.empty) {
            alert('ã‚¢ã‚¤ãƒ‡ã‚¢ãŒã‚ã‚Šã¾ã›ã‚“');
            return;
        }

        const ideas = [];
        snapshot.forEach(doc => {
            const data = doc.data();
            ideas.push(`ã€${data.method}ã€‘${data.idea}`);
        });

        const aiSummary = await callAI(
            `æ¬¡ã®SCAMPERã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ã‚«ãƒ†ã‚´ãƒªåˆ†ã‘ã—ã€å®Ÿç¾å¯èƒ½æ€§ã®é«˜ã„é †ã«æ•´ç†ã—ã¦ãã ã•ã„:\n\n${ideas.join('\n')}`
        );

        document.getElementById("summaryText").textContent = aiSummary;
        document.getElementById("summaryBox").style.display = "block";

    } catch (error) {
        console.error('æ•´ç†ã‚¨ãƒ©ãƒ¼:', error);
        alert('æ•´ç†ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
    } finally {
        btn.disabled = false;
        btn.textContent = 'ğŸ—‚ AIã§æ•´ç†ã™ã‚‹';
    }
});

// === ã€ŒAIã«èãã€ãƒœã‚¿ãƒ³ ===
document.getElementById("aiAskBtn").addEventListener("click", async () => {
    const input = document.getElementById("aiAskInput").value.trim();
    const resultDiv = document.getElementById("aiAskResult");
    const contentDiv = document.getElementById("aiAskContent");

    if (!input) {
        alert("è³ªå•å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
    }

    resultDiv.style.display = "block";
    contentDiv.innerHTML = "<p class='ai-loading'>AIãŒè€ƒãˆä¸­...</p>";

    try {
        const aiText = await callAI(input);
        contentDiv.innerHTML = `<pre>${aiText}</pre>`;
    } catch (error) {
        contentDiv.innerHTML = `<p style="color:#fc8181;">ã‚¨ãƒ©ãƒ¼: ${error.message}</p>`;
    }
});

// === ã‚¢ã‚¤ãƒ‰ãƒ«æ¤œå‡ºï¼ˆ10åˆ†ï¼‰ ===
let idleTimer;
const IDLE_TIMEOUT = 1000 * 60 * 10;
const resetIdleTimer = () => {
    clearTimeout(idleTimer);
    idleTimer = setTimeout(async () => {
        await signOut(auth);
        alert("10åˆ†é–“æ“ä½œãŒãªã‹ã£ãŸãŸã‚è‡ªå‹•ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã•ã‚Œã¾ã—ãŸã€‚");
        location.href = "https://mikatea.sakura.ne.jp/Adeline/index/index.html";
    }, IDLE_TIMEOUT);
};
["mousemove", "keydown", "click", "scroll"].forEach(evt => {
    document.addEventListener(evt, resetIdleTimer, false);
});
resetIdleTimer();
</script>
</body>
</html>