<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>スポンサー企業とマッチング</title>
<link rel="icon" href="https://mikatea.sakura.ne.jp/Adeline/auth/favicon.ico" type="image/x-icon">
<style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: url("./SantaMonica.jpg") center center / cover no-repeat fixed;
    margin: 0;
    padding: 2rem;
    color: #333;
}
h1 {
    text-align: center;
    margin-bottom: 2rem;
    color: #222;
    background: rgba(255, 255, 255, 0.9);
    padding: 1rem 2rem;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    display: inline-block;
    margin-left: 50%;
    transform: translateX(-50%);
}

/* PDF一覧セクション */
.pdf-section {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(10px);
}

.pdf-section h2 {
    margin-bottom: 1rem;
    color: #2d3748;
}

.pdf-list {
    display: grid;
    gap: 1rem;
    margin-bottom: 1rem;
}

.pdf-item {
    display: flex;
    align-items: center;
    padding: 1rem;
    background: #f7fafc;
    border: 2px solid #e2e8f0;
    border-radius: 8px;
    transition: all 0.2s ease;
    cursor: pointer;
}

.pdf-item:hover {
    background: #edf2f7;
    border-color: #cbd5e0;
}

.pdf-item.selected {
    background: #e6fffa;
    border-color: #38b2ac;
}

.pdf-item input[type="radio"] {
    margin-right: 1rem;
    transform: scale(1.2);
}

.pdf-info {
    flex: 1;
}

.pdf-title {
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 0.25rem;
}

.pdf-summary {
    font-size: 0.875rem;
    color: #4a5568;
    margin-bottom: 0.25rem;
}

.pdf-date {
    font-size: 0.75rem;
    color: #718096;
}

.pdf-link {
    margin-left: 1rem;
    color: #3182ce;
    text-decoration: none;
    font-size: 0.875rem;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    background: rgba(49, 130, 206, 0.1);
}

.pdf-link:hover {
    background: rgba(49, 130, 206, 0.2);
    text-decoration: none;
}

.no-pdfs {
    text-align: center;
    color: #718096;
    padding: 2rem;
    font-style: italic;
}

.upload-link {
    display: inline-block;
    background: #38a169;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    text-decoration: none;
    margin-left: 0.5rem;
    font-size: 0.875rem;
}

.upload-link:hover {
    background: #2f855a;
}

.selected-pdf-info {
    background: #f0f9ff;
    border: 1px solid #38bdf8;
    padding: 1rem;
    border-radius: 8px;
    margin-top: 1rem;
    display: none;
}

/* 企業カード */
.company-card {
    background: rgba(255, 255, 255, 0.92);
    border-radius: 10px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    display: flex;
    align-items: center;
    gap: 1.5rem;
    flex-wrap: wrap;
    position: relative;
}

.company-logo {
    width: 80px;
    height: 80px;
    object-fit: contain;
}

.company-info {
    flex: 1;
}

.company-info h2 {
    margin: 0 0 0.4rem 0;
    font-size: 1.3rem;
}

.company-info p {
    margin: 0.2rem 0;
    font-size: 0.95rem;
}

.company-actions {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
}

.cta-button, .submit-button {
    display: inline-block;
    padding: 0.6rem 1.2rem;
    background-color: #00BBF9;
    color: white;
    font-weight: bold;
    border-radius: 8px;
    text-decoration: none;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
    font-size: 0.9rem;
}

.submit-button {
    background-color: #38a169;
}

.submit-button:hover {
    background-color: #2f855a;
}

.submit-button:disabled {
    background-color: #a0aec0;
    cursor: not-allowed;
}

.cta-button:hover {
    background-color: #009ccf;
}

.submission-status {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    margin-top: 0.5rem;
}

.status-submitted {
    background: #c6f6d5;
    color: #22543d;
}

.status-pending {
    background: #fef5e7;
    color: #744210;
}

/* モーダル */
.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(2px);
}

.modal-content {
    background-color: #fefefe;
    margin: 10% auto;
    padding: 2rem;
    border-radius: 12px;
    width: 90%;
    max-width: 500px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.modal-header h3 {
    margin: 0;
}

.close {
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover {
    color: black;
}

.loading {
    text-align: center;
    color: #718096;
    padding: 2rem;
    font-style: italic;
}

@media (max-width: 768px) {
    body {
        padding: 1rem;
    }
    
    .company-card {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .company-actions {
        width: 100%;
        flex-direction: row;
    }
}
</style>
</head>

<body>
<h1>🤝 スポンサー企業とマッチング</h1>

<!-- PDF一覧セクション -->
<section class="pdf-section">
    <h2>📄 提出用企画書を選択</h2>
    <div id="pdfLoadingMessage" class="loading">企画書を読み込み中...</div>
    <div id="pdfList" class="pdf-list" style="display: none;"></div>
    <div id="noPdfs" class="no-pdfs" style="display: none;">
        まだ企画書がアップロードされていません。
        <a href="./proposal.html" class="upload-link">企画書をアップロードする</a>
    </div>
    <div id="selectedPdfInfo" class="selected-pdf-info">
        <strong>選択中:</strong> <span id="selectedPdfTitle"></span>
    </div>
</section>

<!-- 企業一覧 -->
<section id="companiesList">
    <!-- 株式会社Savants -->
    <div class="company-card" data-company="savants">
        <img src="./savants_logo.ico" alt="Savants Logo" class="company-logo">
        <div class="company-info">
            <h2>株式会社Savants</h2>
            <p>すべての人に、知と共創のチャンスを。</p>
            <a href="https://mikatea-entp.github.io/20250523Homework/" target="_blank">🌐 サイトを見る</a>
        </div>
        <div class="company-actions">
            <a href="./proposal.html?target=savants" class="cta-button">💡 新規企画書を作成</a>
            <button class="submit-button" onclick="submitToCompany('savants')" disabled>
                📤 選択中のPDFを提出
            </button>
            <div class="submission-status" id="status-savants"></div>
        </div>
    </div>

    <!-- Lightphoria -->
    <div class="company-card" data-company="lightphoria">
        <img src="https://img.icons8.com/ios-filled/100/light.png" alt="Lightphoria" class="company-logo">
        <div class="company-info">
            <h2>Lightphoria</h2>
            <p>光の言語で都市を照らす。</p>
            <a href="#" target="_blank">🌐 サイトを見る</a>
        </div>
        <div class="company-actions">
            <a href="./proposal.html?target=lightphoria" class="cta-button">💡 新規企画書を作成</a>
            <button class="submit-button" onclick="submitToCompany('lightphoria')" disabled>
                📤 選択中のPDFを提出
            </button>
            <div class="submission-status" id="status-lightphoria"></div>
        </div>
    </div>

    <!-- Re:Plant Inc. -->
    <div class="company-card" data-company="replant">
        <img src="https://img.icons8.com/ios-filled/100/plant-under-sun--v1.png" alt="Re:Plant" class="company-logo">
        <div class="company-info">
            <h2>Re:Plant Inc.</h2>
            <p>サーキュラー時代の再生型農業ソリューション。</p>
            <a href="#" target="_blank">🌐 サイトを見る</a>
        </div>
        <div class="company-actions">
            <a href="./proposal.html?target=replant" class="cta-button">💡 新規企画書を作成</a>
            <button class="submit-button" onclick="submitToCompany('replant')" disabled>
                📤 選択中のPDFを提出
            </button>
            <div class="submission-status" id="status-replant"></div>
        </div>
    </div>

    <!-- Synexa Labs -->
    <div class="company-card" data-company="synexa">
        <img src="https://img.icons8.com/ios-filled/100/brain.png" alt="Synexa" class="company-logo">
        <div class="company-info">
            <h2>Synexa Labs</h2>
            <p>感情とAIをつなぐ、新しい脳神経UX。</p>
            <a href="#" target="_blank">🌐 サイトを見る</a>
        </div>
        <div class="company-actions">
            <a href="./proposal.html?target=synexa" class="cta-button">💡 新規企画書を作成</a>
            <button class="submit-button" onclick="submitToCompany('synexa')" disabled>
                📤 選択中のPDFを提出
            </button>
            <div class="submission-status" id="status-synexa"></div>
        </div>
    </div>

    <!-- HakoWorks -->
    <div class="company-card" data-company="hakoworks">
        <img src="https://img.icons8.com/ios-filled/100/cardboard-box.png" alt="HakoWorks" class="company-logo">
        <div class="company-info">
            <h2>HakoWorks</h2>
            <p>日本の物流を、ハコから変える。</p>
            <a href="#" target="_blank">🌐 サイトを見る</a>
        </div>
        <div class="company-actions">
            <a href="./proposal.html?target=hakoworks" class="cta-button">💡 新規企画書を作成</a>
            <button class="submit-button" onclick="submitToCompany('hakoworks')" disabled>
                📤 選択中のPDFを提出
            </button>
            <div class="submission-status" id="status-hakoworks"></div>
        </div>
    </div>
</section>

<!-- 提出確認モーダル -->
<div id="confirmModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>提出確認</h3>
            <span class="close">&times;</span>
        </div>
        <div id="modalContent">
            <p id="confirmText"></p>
            <div style="margin-top: 1.5rem; text-align: right;">
                <button onclick="closeModal()" style="background: #cbd5e0; color: #2d3748; border: none; padding: 0.5rem 1rem; border-radius: 6px; margin-right: 0.5rem; cursor: pointer;">キャンセル</button>
                <button id="confirmSubmit" style="background: #38a169; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer;">提出する</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
import { getFirestore, collection, query, where, orderBy, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

// Firebase構成
// ★githubアップ時に忘れず消すこと！★
const firebaseConfig = {
    apiKey: "",
    authDomain: "",
    projectId: "",
    storageBucket: "",
    messagingSenderId: "",
    appId: "",
    measurementId: ""
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let currentUser = null;
let userProposals = [];
let selectedProposal = null;

// グローバル関数として定義
window.submitToCompany = submitToCompany;
window.closeModal = closeModal;

// 未ログインならリダイレクト
onAuthStateChanged(auth, async (user) => {
    if (!user) {
        location.href = "../auth/auth.html";
        return;
    }
    
    currentUser = user;
    await loadUserProposals();
    await checkSubmissionStatuses();
});

// ユーザーの企画書を読み込み
async function loadUserProposals() {
    try {
        const q = query(
            collection(db, "proposals"),
            where("userId", "==", currentUser.uid),
            orderBy("createdAt", "desc")
        );
        
        const querySnapshot = await getDocs(q);
        userProposals = [];
        
        querySnapshot.forEach((doc) => {
            userProposals.push({
                id: doc.id,
                ...doc.data()
            });
        });

        renderProposalsList();
        
    } catch (error) {
        console.error("企画書読み込みエラー:", error);
        document.getElementById("pdfLoadingMessage").textContent = "企画書の読み込みに失敗しました。";
    }
}

// 企画書一覧を表示
function renderProposalsList() {
    const loadingDiv = document.getElementById("pdfLoadingMessage");
    const listDiv = document.getElementById("pdfList");
    const noPdfsDiv = document.getElementById("noPdfs");

    loadingDiv.style.display = "none";

    if (userProposals.length === 0) {
        noPdfsDiv.style.display = "block";
        return;
    }

    listDiv.style.display = "block";
    listDiv.innerHTML = "";

    userProposals.forEach((proposal, index) => {
        const pdfItem = document.createElement("div");
        pdfItem.className = "pdf-item";
        
        const createdAt = proposal.createdAt?.toDate();
        const dateStr = createdAt ? createdAt.toLocaleDateString("ja-JP") : "日付不明";
        
        pdfItem.innerHTML = `
            <input type="radio" name="selectedPdf" value="${proposal.id}" id="pdf-${index}">
            <div class="pdf-info">
                <div class="pdf-title">${proposal.title || "無題"}</div>
                <div class="pdf-summary">${proposal.summary || "概要なし"}</div>
                <div class="pdf-date">アップロード日: ${dateStr}</div>
            </div>
            <a href="${proposal.fileUrl}" target="_blank" class="pdf-link">📄 PDFを開く</a>
        `;

        // ラジオボタン選択時の処理
        const radio = pdfItem.querySelector('input[type="radio"]');
        radio.addEventListener('change', () => {
            if (radio.checked) {
                selectedProposal = proposal;
                updateSelectedPdfInfo();
                enableSubmitButtons();
                
                // 他のアイテムの選択状態を解除
                document.querySelectorAll('.pdf-item').forEach(item => {
                    item.classList.remove('selected');
                });
                pdfItem.classList.add('selected');
            }
        });

        // アイテム全体クリックでも選択
        pdfItem.addEventListener('click', (e) => {
            if (e.target.tagName !== 'A') {
                radio.checked = true;
                radio.dispatchEvent(new Event('change'));
            }
        });

        listDiv.appendChild(pdfItem);
    });
}

// 選択されたPDF情報を更新
function updateSelectedPdfInfo() {
    const infoDiv = document.getElementById("selectedPdfInfo");
    const titleSpan = document.getElementById("selectedPdfTitle");
    
    if (selectedProposal) {
        titleSpan.textContent = selectedProposal.title || "無題";
        infoDiv.style.display = "block";
    } else {
        infoDiv.style.display = "none";
    }
}

// 提出ボタンを有効化
function enableSubmitButtons() {
    const buttons = document.querySelectorAll(".submit-button");
    buttons.forEach(button => {
        button.disabled = !selectedProposal;
    });
}

// 提出状況をチェック
async function checkSubmissionStatuses() {
    if (!currentUser) return;

    try {
        const q = query(
            collection(db, "submissions"),
            where("userId", "==", currentUser.uid)
        );
        
        const querySnapshot = await getDocs(q);
        const submissions = {};
        
        querySnapshot.forEach((doc) => {
            const data = doc.data();
            submissions[data.companyId] = data;
        });

        // 各企業の状況を更新
        const companies = ['savants', 'lightphoria', 'replant', 'synexa', 'hakoworks'];
        companies.forEach(companyId => {
            const statusDiv = document.getElementById(`status-${companyId}`);
            const submission = submissions[companyId];
            
            if (submission) {
                const submittedAt = submission.submittedAt?.toDate();
                const dateStr = submittedAt ? submittedAt.toLocaleDateString("ja-JP") : "";
                
                statusDiv.textContent = `提出済み (${dateStr})`;
                statusDiv.className = "submission-status status-submitted";
            } else {
                statusDiv.textContent = "";
                statusDiv.className = "submission-status";
            }
        });
        
    } catch (error) {
        console.error("提出状況チェックエラー:", error);
    }
}

// 企業への提出処理
async function submitToCompany(companyId) {
    if (!selectedProposal) {
        alert("提出する企画書を選択してください。");
        return;
    }

    // 確認モーダルを表示
    const modal = document.getElementById("confirmModal");
    const confirmText = document.getElementById("confirmText");
    const confirmButton = document.getElementById("confirmSubmit");
    
    const companyNames = {
        'savants': '株式会社Savants',
        'lightphoria': 'Lightphoria',
        'replant': 'Re:Plant Inc.',
        'synexa': 'Synexa Labs',
        'hakoworks': 'HakoWorks'
    };
    
    confirmText.innerHTML = `
        <strong>${companyNames[companyId]}</strong>に<br>
        「<strong>${selectedProposal.title}</strong>」<br>
        を提出しますか？
    `;
    
    // 確認ボタンのイベントリスナーを再設定
    confirmButton.onclick = () => executeSubmission(companyId);
    
    modal.style.display = "block";
}

// 実際の提出処理
async function executeSubmission(companyId) {
    try {
        // 既に提出済みかチェック
        const existingQuery = query(
            collection(db, "submissions"),
            where("userId", "==", currentUser.uid),
            where("companyId", "==", companyId)
        );
        
        const existingDocs = await getDocs(existingQuery);
        
        if (!existingDocs.empty) {
            alert("この企業には既に提出済みです。");
            closeModal();
            return;
        }

        // 提出データを作成
        const submissionData = {
            userId: currentUser.uid,
            companyId: companyId,
            proposalId: selectedProposal.id,
            proposalTitle: selectedProposal.title,
            proposalSummary: selectedProposal.summary,
            proposalFileUrl: selectedProposal.fileUrl,
            submittedAt: serverTimestamp(),
            status: "submitted"
        };

        // Firestoreに保存
        await addDoc(collection(db, "submissions"), submissionData);
        
        alert("提出が完了しました！");
        closeModal();
        
        // 提出状況を再チェック
        await checkSubmissionStatuses();
        
    } catch (error) {
        console.error("提出エラー:", error);
        alert("提出に失敗しました: " + error.message);
    }
}

// モーダルを閉じる
function closeModal() {
    document.getElementById("confirmModal").style.display = "none";
}

// モーダル外クリックで閉じる
document.getElementById("confirmModal").addEventListener("click", (e) => {
    if (e.target.id === "confirmModal") {
        closeModal();
    }
});

// アイドル検出（10分）
let idleTimer;
const IDLE_TIMEOUT = 1000 * 60 * 10;
const resetIdleTimer = () => {
    clearTimeout(idleTimer);
    idleTimer = setTimeout(async () => {
        await signOut(auth);
        alert("10分間操作がなかったため自動ログアウトされました。");
        location.href = "https://mikatea.sakura.ne.jp/Adeline/index/index.html";
    }, IDLE_TIMEOUT);
};
["mousemove", "keydown", "click", "scroll"].forEach(evt => {
    document.addEventListener(evt, resetIdleTimer, false);
});
resetIdleTimer();
</script>

</body>
</html>